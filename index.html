<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3498db">
    <meta name="description" content="Secure FD Manager with PIN protection">
    <link rel="manifest" id="manifest-placeholder">
    <title>FD Manager Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="dark"] {
            --primary: #5dade2;
            --success: #58d68d;
            --danger: #ec7063;
            --warning: #f8c471;
            --dark: #ecf0f1;
            --light: #1a1a1a;
            --bg-gradient: linear-gradient(135deg, #2c3e50, #1a1a1a);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-box h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .login-box .emoji {
            text-align: center;
            font-size: 4em;
            margin-bottom: 20px;
        }
        .pin-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }
        .pin-digit {
            width: 50px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: var(--light);
        }
        .pin-digit:focus {
            outline: none;
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        .app-container {
            display: none;
            padding: 20px;
            padding-left: 70px;
        }
        .app-container.active { display: block; }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .theme-toggle, .notification-toggle, .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .notification-toggle { top: 80px; background: var(--success); }
        .logout-btn { top: 140px; background: var(--danger); }
        .notification-toggle.disabled { background: var(--danger); }
        .theme-toggle:hover { transform: rotate(180deg) scale(1.1); }
        .notification-toggle:hover, .logout-btn:hover { transform: scale(1.1); }
        .drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--dark);
            color: white;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }
        .drawer.open { left: 0; }
        .drawer-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 8px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .drawer-toggle:hover { transform: scale(1.1); }
        .drawer-menu { padding: 60px 0 20px 0; }
        .drawer-menu a {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .drawer-menu a:hover, .drawer-menu a.active {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--primary);
        }
        .card {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        input, select, textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark);
        }
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #2c3e50;
            color: white;
            border-color: #34495e;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--success);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        button:active { transform: translateY(0); }
        button.danger { background: var(--danger); }
        button.primary { background: var(--primary); }
        button.warning { background: var(--warning); }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            overflow-x: auto;
            display: block;
        }
        @media (min-width: 768px) { table { display: table; } }
        thead {
            background: var(--primary);
            color: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        th:hover { background: rgba(0,0,0,0.1); }
        tbody tr { transition: all 0.3s ease; }
        tbody tr:hover { background: rgba(52, 152, 219, 0.1); }
        .status-active { color: var(--success); font-weight: 600; }
        .status-matured { color: var(--danger); font-weight: 600; }
        .status-expiring { color: var(--warning); font-weight: 600; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .widget {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .widget h3 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .widget .value {
            font-size: 2em;
            font-weight: bold;
        }
        .widget.success { background: var(--success); }
        .widget.danger { background: var(--danger); }
        .widget.warning { background: var(--warning); }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 2000;
            animation: slideUpToast 0.3s ease;
            max-width: 350px;
        }
        @keyframes slideUpToast {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .hidden { display: none !important; }
        .timeline { position: relative; padding: 20px 0; }
        .timeline-item {
            padding: 20px;
            background: white;
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .search-container {
            position: relative;
            margin: 20px 0;
        }
        .search-container input {
            width: 100%;
            padding-left: 40px;
        }
        .search-container::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .chip {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .chip:hover { transform: scale(1.05); }
        .chip.active { background: var(--success); }
        .comparison-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--primary);
            text-align: center;
            transition: all 0.3s ease;
        }
        .comparison-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .comparison-card.best {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.1);
        }
        .certificate-preview {
            margin: 15px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            border: 2px dashed var(--primary);
        }
        .certificate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin: 5px 0;
        }
        .certificate-item img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        .modal-content img {
            max-width: 100%;
            height: auto;
        }
        @media (max-width: 768px) {
            .app-container {
                padding-left: 20px;
                padding-right: 20px;
            }
            .header h1 { font-size: 1.8em; }
            .form-grid { grid-template-columns: 1fr; }
            .drawer-toggle { top: 10px; left: 10px; }
            .theme-toggle, .notification-toggle, .logout-btn { right: 10px; }
            .btn-group { flex-direction: column; }
            .btn-group button { width: 100%; }
            table { font-size: 12px; }
            th, td { padding: 8px 4px; }
            .pin-digit {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="emoji">üîê</div>
            <h1>FD Manager Pro</h1>
            <p style="text-align: center; color: #666; margin-bottom: 20px;" id="loginMessage">Enter your 4-digit PIN</p>
            <div class="pin-input">
                <input type="password" maxlength="1" class="pin-digit" id="pin1" oninput="movePinFocus(1)">
                <input type="password" maxlength="1" class="pin-digit" id="pin2" oninput="movePinFocus(2)">
                <input type="password" maxlength="1" class="pin-digit" id="pin3" oninput="movePinFocus(3)">
                <input type="password" maxlength="1" class="pin-digit" id="pin4" oninput="movePinFocus(4)">
            </div>
            <button onclick="verifyPIN()" style="width: 100%; margin-top: 20px;">Login</button>
            <button onclick="resetPIN()" class="danger" style="width: 100%; margin-top: 10px;">Reset PIN</button>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                First time? Set a 4-digit PIN to secure your data
            </p>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <button class="drawer-toggle" onclick="toggleDrawer()">‚ò∞</button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåì</button>
        <button class="notification-toggle" onclick="toggleNotifications()" id="notifBtn" title="Toggle Notifications">üîî</button>
        <button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
        
        <div class="drawer" id="drawer">
            <div class="drawer-menu">
                <a href="#" onclick="showTab('dashboard')" class="active">üìä Dashboard</a>
                <a href="#" onclick="showTab('records')">üíº FD Records</a>
                <a href="#" onclick="showTab('interest')">üßÆ Interest Calculator</a>
                <a href="#" onclick="showTab('analytics')">üìà Analytics</a>
                <a href="#" onclick="showTab('timeline')">‚è±Ô∏è Timeline</a>
                <a href="#" onclick="showTab('comparison')">‚öñÔ∏è Compare Banks</a>
                <a href="#" onclick="showTab('certificates')">üìÑ Certificates</a>
                <a href="#" onclick="showTab('settings')">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <h1>üí∞ FD Manager Pro</h1>
                <p>Secure Fixed Deposit Management</p>
            </div>

            <div id="tab-dashboard" class="tab-content active">
                <div class="widget-grid">
                    <div class="widget primary">
                        <h3>Total Investment</h3>
                        <div class="value" id="dashTotalInvestment">‚Çπ0</div>
                    </div>
                    <div class="widget success">
                        <h3>Expected Interest</h3>
                        <div class="value" id="dashTotalInterest">‚Çπ0</div>
                    </div>
                    <div class="widget warning">
                        <h3>Active FDs</h3>
                        <div class="value" id="dashActiveFDs">0</div>
                    </div>
                    <div class="widget danger">
                        <h3>Expiring Soon</h3>
                        <div class="value" id="dashExpiringSoon">0</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div class="btn-group">
                        <button onclick="showTab('records')">‚ûï Add New FD</button>
                        <button class="primary" onclick="showTab('interest')">üßÆ Calculate Interest</button>
                        <button class="warning" onclick="checkMaturityAlerts()">üîî Check Alerts</button>
                        <button class="danger" onclick="backupData()">üíæ Backup Data</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Upcoming Maturities (Next 30 Days)</h2>
                    <div id="dashboardMaturities"></div>
                </div>

                <div class="card">
                    <h2>Portfolio Distribution</h2>
                    <div class="chart-container">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-records" class="tab-content">
                <div class="card">
                    <h2>Account Holder Management</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Select Account Holder</label>
                            <select id="accountHolderSelect" onchange="loadAccountRecords()"></select>
                        </div>
                        <div class="form-group">
                            <label>Add New Account Holder</label>
                            <input type="text" id="newAccountHolder" placeholder="Enter name">
                        </div>
                    </div>
                    <button onclick="addAccountHolder()">Add Account Holder</button>
                    <button class="danger" onclick="deleteAccountHolder()">Delete Selected</button>
                </div>

                <div class="card">
                    <h2>FD Records - <span id="currentHolder">No Holder Selected</span></h2>
                    
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search by bank, amount..." oninput="filterRecords()">
                    </div>

                    <div class="filter-chips">
                        <div class="chip active" onclick="filterByStatus('all')">All</div>
                        <div class="chip" onclick="filterByStatus('active')">Active</div>
                        <div class="chip" onclick="filterByStatus('expiring')">Expiring Soon</div>
                        <div class="chip" onclick="filterByStatus('matured')">Matured</div>
                    </div>

                    <div class="btn-group">
                        <button onclick="clearSelection()">Clear Selection</button>
                        <button class="danger" onclick="bulkDelete()">Delete Selected</button>
                        <button class="primary" onclick="bulkExport()">Export Selected</button>
                        <button class="warning" onclick="exportAllToPDF()">Export PDF</button>
                        <button class="success" onclick="exportAllToExcel()">Export Excel</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th onclick="sortTable('bankName')">Bank ‚Üï</th>
                                    <th onclick="sortTable('amount')">Amount ‚Üï</th>
                                    <th onclick="sortTable('duration')">Duration ‚Üï</th>
                                    <th onclick="sortTable('interestRate')">Rate% ‚Üï</th>
                                    <th onclick="sortTable('fdStartDate')">Start ‚Üï</th>
                                    <th onclick="sortTable('fdMaturityDate')">Maturity ‚Üï</th>
                                    <th onclick="sortTable('fdRenewalDaysRemaining')">Days ‚Üï</th>
                                    <th onclick="sortTable('interest')">Interest ‚Üï</th>
                                    <th>Certificate</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2>Add/Edit FD Record</h2>
                    <form id="fdForm" onsubmit="saveFDRecord(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Bank Name *</label>
                                <input type="text" id="bankName" list="bankSuggestions" required>
                                <datalist id="bankSuggestions"></datalist>
                            </div>
                            <div class="form-group">
                                <label>Amount (‚Çπ) *</label>
                                <input type="number" id="amount" min="1" step="0.01" required oninput="calculatePreview()">
                            </div>
                            <div class="form-group">
                                <label>Duration *</label>
                                <input type="number" id="duration" min="1" required oninput="calculatePreview()">
                            </div>
                            <div class="form-group">
                                <label>Duration Unit</label>
                                <select id="durationUnit" onchange="calculatePreview()">
                                    <option value="Days">Days</option>
                                    <option value="Months">Months</option>
                                    <option value="Years">Years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (%) *</label>
                                <input type="number" id="interestRate" min="0" step="0.01" value="5" required oninput="calculatePreview()">
                            </div>
                            <div class="form-group">
                                <label>Start Date *</label>
                                <input type="date" id="fdStartDate" required oninput="calculatePreview()">
                            </div>
                            <div class="form-group">
                                <label>Certificate Status</label>
                                <select id="fdCertificate">
                                    <option value="obtained">Obtained</option>
                                    <option value="not obtained">Not Obtained</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Upload Certificate (PDF/Image)</label>
                                <input type="file" id="certificateFile" accept=".pdf,.jpg,.jpeg,.png" onchange="previewCertificate()">
                            </div>
                            <div class="form-group">
                                <label>Notes (Optional)</label>
                                <textarea id="fdNotes" rows="2" placeholder="Add notes..."></textarea>
                            </div>
                        </div>
                        
                        <div id="certificatePreview" class="certificate-preview hidden">
                            <p><strong>Certificate Preview:</strong></p>
                            <div id="certPreviewContent"></div>
                        </div>

                        <input type="hidden" id="editIndex" value="">
                        <p style="margin: 15px 0; font-size: 1.1em; font-weight: 600;">
                            Estimated Interest: <span id="interestPreview" style="color: var(--success);">‚Çπ0.00</span>
                        </p>
                        <div class="btn-group">
                            <button type="submit">üíæ Save Record</button>
                            <button type="button" onclick="clearForm()">üîÑ Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="tab-interest" class="tab-content">
                <div class="card">
                    <h2>Advanced Interest Calculator</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Account Holder</label>
                            <select id="interestAccountHolder" onchange="loadFDsForInterest()"></select>
                        </div>
                        <div class="form-group">
                            <label>Select FD</label>
                            <select id="fdRecordSelect" onchange="populateInterestFields()"></select>
                        </div>
                        <div class="form-group">
                            <label>Calculation Period</label>
                            <select id="calcPeriod" onchange="togglePeriodFields()">
                                <option value="whole">Whole FD Period</option>
                                <option value="custom">Custom Date Range</option>
                                <option value="manual">Manual Input</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Interest Type</label>
                            <select id="interestType">
                                <option value="simple">Simple Interest</option>
                                <option value="compound">Compound Interest</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Compounding Frequency</label>
                            <select id="interestFrequency">
                                <option value="atMaturity">At Maturity</option>
                                <option value="daily">Daily</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="annually">Annually</option>
                            </select>
                        </div>
                    </div>

                    <div id="customDateFields" class="form-grid hidden">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="interestFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="interestToDate">
                        </div>
                    </div>

                    <div id="manualInputFields" class="form-grid hidden">
                        <div class="form-group">
                            <label>Principal Amount (‚Çπ)</label>
                            <input type="number" id="manualAmount" min="1" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" id="manualRate" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="number" id="manualDuration" min="1">
                        </div>
                        <div class="form-group">
                            <label>Duration Unit</label>
                            <select id="manualUnit">
                                <option value="Days">Days</option>
                                <option value="Months">Months</option>
                                <option value="Years">Years</option>
                            </select>
                        </div>
                    </div>

                    <button class="primary" onclick="calculateInterest()">üßÆ Calculate Interest</button>
                    
                    <div style="background: var(--success); color: white; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                        <h3>Calculated Interest</h3>
                        <div style="font-size: 2.5em; font-weight: bold;" id="calculatedInterest">‚Çπ0.00</div>
                    </div>

                    <button onclick="saveInterestCalculation()">üíæ Save This Calculation</button>
                </div>

                <div class="card">
                    <h2>Saved Interest Calculations</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Rate %</th>
                                    <th>Type</th>
                                    <th>Interest</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="savedInterestTable"></tbody>
                        </table>
                    </div>
                    <div class="btn-group">
                        <button class="danger" onclick="clearAllSavedInterest()">Clear All</button>
                        <button class="warning" onclick="exportSavedInterestPDF()">Export PDF</button>
                        <button class="success" onclick="exportSavedInterestExcel()">Export Excel</button>
                    </div>
                </div>
            </div>

            <div id="tab-analytics" class="tab-content">
                <div class="card">
                    <h2>Portfolio Analytics</h2>
                    <div class="btn-group">
                        <button onclick="generateChart('pie')">ü•ß Pie Chart</button>
                        <button onclick="generateChart('bar')">üìä Bar Chart</button>
                        <button onclick="generateChart('line')">üìà Line Chart</button>
                        <button onclick="generateChart('doughnut')">üç© Doughnut Chart</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>Bank Performance Analysis</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Bank Name</th>
                                    <th>Total FDs</th>
                                    <th>Total Investment</th>
                                    <th>Total Interest</th>
                                    <th>Avg. Rate</th>
                                </tr>
                            </thead>
                            <tbody id="bankAnalysisTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-timeline" class="tab-content">
                <div class="card">
                    <h2>Investment Timeline</h2>
                    <div class="timeline" id="timelineView"></div>
                </div>
            </div>

            <div id="tab-comparison" class="tab-content">
                <div class="card">
                    <h2>Compare FD Offers</h2>
                    <form id="comparisonForm" onsubmit="addComparison(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Bank Name</label>
                                <input type="text" id="compBankName" required>
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (%)</label>
                                <input type="number" id="compRate" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Duration (Months)</label>
                                <input type="number" id="compDuration" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Minimum Amount (‚Çπ)</label>
                                <input type="number" id="compMinAmount" min="0" step="1">
                            </div>
                        </div>
                        <button type="submit">‚ûï Add to Comparison</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Comparison Results</h2>
                    <div class="comparison-table" id="comparisonResults"></div>
                    <button class="danger" onclick="clearComparisons()">Clear All</button>
                </div>
            </div>

            <div id="tab-certificates" class="tab-content">
                <div class="card">
                    <h2>FD Certificates</h2>
                    <p style="color: var(--warning); margin-bottom: 15px;">
                        üìã View and manage all uploaded FD certificates
                    </p>
                    <div id="certificatesList"></div>
                </div>
            </div>

            <div id="tab-settings" class="tab-content">
                <div class="card">
                    <h2>Application Settings</h2>
                    
                    <h3>Security Settings</h3>
                    <button onclick="changePIN()" class="warning">üîí Change PIN</button>
                    
                    <h3 style="margin-top: 20px;">Notification Settings</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNotifications" onchange="saveSettings()">
                            Enable Browser Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Alert me before (days)</label>
                        <select id="alertDays" onchange="saveSettings()">
                            <option value="7">7 Days</option>
                            <option value="15">15 Days</option>
                            <option value="30" selected>30 Days</option>
                            <option value="60">60 Days</option>
                        </select>
                    </div>

                    <h3>Display Settings</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoSave" checked onchange="saveSettings()">
                            Enable Auto-Save
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Currency Symbol</label>
                        <select id="currencySymbol" onchange="saveSettings()">
                            <option value="‚Çπ" selected>‚Çπ (Rupee)</option>
                            <option value="$">$ (Dollar)</option>
                            <option value="‚Ç¨">‚Ç¨ (Euro)</option>
                            <option value="¬£">¬£ (Pound)</option>
                        </select>
                    </div>

                    <h3>Data Management</h3>
                    <div class="btn-group">
                        <button onclick="backupData()">üíæ Backup All Data</button>
                        <button class="primary" onclick="restoreData()">üì• Restore Data</button>
                        <button class="danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>

                    <h3>About</h3>
                    <p>FD Manager Pro v3.0</p>
                    <p>Designed by Santosh Phuyal</p>
                    <p>‚ú® Features: PIN Security, Certificate Upload, PWA Support</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="certificateModal" onclick="closeCertificateModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="closeCertificateModal()" class="danger" style="float: right;">‚úï Close</button>
            <div id="modalCertificateContent"></div>
        </div>
    </div>

    <script>
        const ENCRYPTION_KEY = 'FDManagerPro_v3_SecureKey_2025';
        let currentFilter = 'all';
        let currentSort = { field: null, ascending: true };
        let notificationsEnabled = false;
        let dashboardChart = null;
        let analyticsChart = null;
        let currentCertificateFile = null;

        const manifest = {
            name: "FD Manager Pro",
            short_name: "FD Manager",
            description: "Secure Fixed Deposit Management",
            start_url: ".",
            display: "standalone",
            background_color: "#667eea",
            theme_color: "#3498db",
            icons: [{
                src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%233498db'/><text x='50%25' y='50%25' font-size='80' text-anchor='middle' fill='white' dy='.3em'>FD</text></svg>",
                sizes: "192x192",
                type: "image/svg+xml"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        function encrypt(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        }

        function decrypt(data) {
            if (!data) return [];
            try {
                const bytes = CryptoJS.AES.decrypt(data, ENCRYPTION_KEY);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8)) || [];
            } catch { return []; }
        }

        function getAccountHolders() { return decrypt(localStorage.getItem('accountHolders')); }
        function saveAccountHolders(holders) { localStorage.setItem('accountHolders', encrypt(holders)); }
        function getRecords(holder) { return decrypt(localStorage.getItem(`records_${holder}`)); }
        function saveRecords(holder, records) { localStorage.setItem(`records_${holder}`, encrypt(records)); }
        function getSavedInterest() { return decrypt(localStorage.getItem('savedInterest')); }
        function saveSavedInterest(data) { localStorage.setItem('savedInterest', encrypt(data)); }
        function getComparisons() { return decrypt(localStorage.getItem('comparisons')); }
        function saveComparisons(data) { localStorage.setItem('comparisons', encrypt(data)); }
        function getCertificates() { return decrypt(localStorage.getItem('certificates')); }
        function saveCertificates(data) { localStorage.setItem('certificates', encrypt(data)); }

        function getSettings() {
            const defaults = { enableNotifications: false, alertDays: 30, autoSave: true, currencySymbol: '‚Çπ', theme: 'light' };
            const saved = localStorage.getItem('settings');
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        }

        function saveSettings() {
            const settings = {
                enableNotifications: document.getElementById('enableNotifications').checked,
                alertDays: parseInt(document.getElementById('alertDays').value),
                autoSave: document.getElementById('autoSave').checked,
                currencySymbol: document.getElementById('currencySymbol').value,
                theme: document.body.getAttribute('data-theme') || 'light'
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            showToast('Settings saved', 'success');
        }

        function movePinFocus(current) {
            if (current < 4) {
                const nextInput = document.getElementById(`pin${current + 1}`);
                if (document.getElementById(`pin${current}`).value.length === 1) {
                    nextInput.focus();
                }
            } else {
                verifyPIN();
            }
        }

        function verifyPIN() {
            const pin = ['pin1', 'pin2', 'pin3', 'pin4']
                .map(id => document.getElementById(id).value)
                .join('');

            if (pin.length !== 4) {
                showToast('Please enter complete PIN', 'error');
                return;
            }

            const savedPIN = localStorage.getItem('userPIN');

            if (!savedPIN) {
                const hashedPIN = CryptoJS.SHA256(pin).toString();
                localStorage.setItem('userPIN', hashedPIN);
                showToast('PIN set successfully!', 'success');
                loginSuccess();
            } else {
                const hashedPIN = CryptoJS.SHA256(pin).toString();
                if (hashedPIN === savedPIN) {
                    loginSuccess();
                } else {
                    showToast('Incorrect PIN!', 'error');
                    clearPINFields();
                }
            }
        }

        function loginSuccess() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            loadAccountHolders();
            updateDashboard();
            showToast('Welcome back!', 'success');
            const theme = getSettings().theme;
            if (theme) document.body.setAttribute('data-theme', theme);
        }

        function logout() {
            if (!confirm('Logout?')) return;
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            clearPINFields();
            showToast('Logged out successfully', 'success');
        }

        function clearPINFields() {
            ['pin1', 'pin2', 'pin3', 'pin4'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('pin1').focus();
        }

        function resetPIN() {
            if (!confirm('‚ö†Ô∏è This will delete all your data! Continue?')) return;
            if (!confirm('Are you absolutely sure?')) return;
            localStorage.clear();
            location.reload();
        }

        function changePIN() {
            const oldPin = prompt('Enter current PIN:');
            if (!oldPin) return;

            const savedPIN = localStorage.getItem('userPIN');
            const hashedOldPIN = CryptoJS.SHA256(oldPin).toString();

            if (hashedOldPIN !== savedPIN) {
                showToast('Incorrect current PIN!', 'error');
                return;
            }

            const newPin = prompt('Enter new 4-digit PIN:');
            if (!newPin || newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                showToast('Invalid PIN format', 'error');
                return;
            }

            const confirmPin = prompt('Confirm new PIN:');
            if (newPin !== confirmPin) {
                showToast('PINs do not match', 'error');
                return;
            }

            const hashedNewPIN = CryptoJS.SHA256(newPin).toString();
            localStorage.setItem('userPIN', hashedNewPIN);
            showToast('PIN changed successfully!', 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.drawer-menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'timeline') loadTimeline();
            if (tabName === 'certificates') loadCertificates();
            if (tabName === 'settings') loadSettingsUI();
            
            toggleDrawer();
        }

        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function toggleNotifications() {
            if (!('Notification' in window)) {
                showToast('Notifications not supported', 'error');
                return;
            }
            
            if (Notification.permission === 'granted') {
                notificationsEnabled = !notificationsEnabled;
                document.getElementById('notifBtn').classList.toggle('disabled');
                showToast(notificationsEnabled ? 'Notifications enabled' : 'Notifications disabled', 'success');
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        showToast('Notifications enabled', 'success');
                    }
                });
            }
        }

        function formatCurrency(amount) {
            const symbol = getSettings().currencySymbol;
            return symbol + parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-IN');
        }

        function calculateMaturityDate(startDate, duration, unit) {
            const date = new Date(startDate);
            const dur = parseInt(duration);
            if (unit === 'Days') date.setDate(date.getDate() + dur);
            else if (unit === 'Months') date.setMonth(date.getMonth() + dur);
            else if (unit === 'Years') date.setFullYear(date.getFullYear() + dur);
            return date.toISOString().split('T')[0];
        }

        function calculateDaysRemaining(maturityDate) {
            const today = new Date();
            const maturity = new Date(maturityDate);
            return Math.ceil((maturity - today) / (1000 * 60 * 60 * 24));
        }

        function calculateSimpleInterest(principal, rate, years) {
            return principal * (rate / 100) * years;
        }

        function calculateCompoundInterest(principal, rate, years, frequency) {
            const freqMap = { daily: 365, monthly: 12, quarterly: 4, annually: 1, atMaturity: 1 };
            const n = freqMap[frequency] || 1;
            return principal * Math.pow(1 + (rate / 100) / n, n * years) - principal;
        }

        function getDurationInYears(duration, unit) {
            if (unit === 'Days') return duration / 365.25;
            if (unit === 'Months') return duration / 12;
            return duration;
        }

        function previewCertificate() {
            const file = document.getElementById('certificateFile').files[0];
            if (!file) return;

            if (file.size > 5000000) {
                showToast('File too large (max 5MB)', 'error');
                document.getElementById('certificateFile').value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentCertificateFile = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result
                };

                const preview = document.getElementById('certificatePreview');
                const content = document.getElementById('certPreviewContent');
                
                if (file.type.startsWith('image/')) {
                    content.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                } else if (file.type === 'application/pdf') {
                    content.innerHTML = `<p>üìÑ ${file.name} (PDF)</p>`;
                }
                
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function loadCertificates() {
            const container = document.getElementById('certificatesList');
            container.innerHTML = '';

            const certificates = getCertificates();
            
            if (!certificates.length) {
                container.innerHTML = '<p>No certificates uploaded yet</p>';
                return;
            }

            certificates.forEach((cert, index) => {
                const item = document.createElement('div');
                item.className = 'certificate-item';
                
                let preview = '';
                if (cert.fileType.startsWith('image/')) {
                    preview = `<img src="${cert.fileData}" onclick="viewCertificate(${index})">`;
                } else {
                    preview = `<span onclick="viewCertificate(${index})" style="cursor: pointer;">üìÑ ${cert.fileName}</span>`;
                }

                item.innerHTML = `
                    <div>${preview}</div>
                    <div>
                        <strong>${cert.holder} - ${cert.bankName}</strong><br>
                        <small>${formatCurrency(cert.amount)}</small>
                    </div>
                    <div>
                        <button class="danger" onclick="deleteCertificate(${index})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function viewCertificate(index) {
            const certificates = getCertificates();
            const cert = certificates[index];
            
            const modal = document.getElementById('certificateModal');
            const content = document.getElementById('modalCertificateContent');
            
            if (cert.fileType.startsWith('image/')) {
                content.innerHTML = `
                    <h2>${cert.holder} - ${cert.bankName}</h2>
                    <p>${formatCurrency(cert.amount)}</p>
                    <img src="${cert.fileData}" style="max-width: 100%; margin-top: 20px;">
                `;
            } else {
                content.innerHTML = `
                    <h2>${cert.holder} - ${cert.bankName}</h2>
                    <p>${formatCurrency(cert.amount)}</p>
                    <p>üìÑ ${cert.fileName}</p>
                    <a href="${cert.fileData}" download="${cert.fileName}">
                        <button>Download PDF</button>
                    </a>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeCertificateModal() {
            document.getElementById('certificateModal').classList.remove('active');
        }

        function deleteCertificate(index) {
            if (!confirm('Delete this certificate?')) return;
            
            let certificates = getCertificates();
            certificates.splice(index, 1);
            saveCertificates(certificates);
            loadCertificates();
            showToast('Certificate deleted', 'success');
        }

        function loadAccountHolders() {
            const holders = getAccountHolders();
            const select = document.getElementById('accountHolderSelect');
            const interestSelect = document.getElementById('interestAccountHolder');
            
            [select, interestSelect].forEach(sel => {
                if (!sel) return;
                sel.innerHTML = '<option value="">-- Select --</option>';
                holders.forEach(holder => {
                    const option = document.createElement('option');
                    option.value = option.textContent = holder;
                    sel.appendChild(option);
                });
            });

            if (holders.length) {
                select.value = holders[0];
                interestSelect.value = holders[0];
                loadAccountRecords();
            }
        }

        function addAccountHolder() {
            const input = document.getElementById('newAccountHolder');
            const name = input.value.trim();
            if (!name) return showToast('Please enter a name', 'error');
            
            const holders = getAccountHolders();
            if (holders.includes(name)) return showToast('Account holder already exists', 'error');
            
            holders.push(name);
            saveAccountHolders(holders);
            loadAccountHolders();
            document.getElementById('accountHolderSelect').value = name;
            input.value = '';
            showToast('Account holder added', 'success');
            loadAccountRecords();
        }

        function deleteAccountHolder() {
            const select = document.getElementById('accountHolderSelect');
            const name = select.value;
            if (!name) return showToast('Select an account holder first', 'error');
            if (!confirm(`Delete "${name}" and all their FD records?`)) return;
            
            let holders = getAccountHolders();
            holders = holders.filter(h => h !== name);
            saveAccountHolders(holders);
            localStorage.removeItem(`records_${name}`);
            loadAccountHolders();
            showToast('Account holder deleted', 'success');
        }

        function loadAccountRecords() {
            const holder = document.getElementById('accountHolderSelect')?.value;
            if (!holder) return;
            
            document.getElementById('currentHolder').textContent = holder;
            
            let records = getRecords(holder);
            records = records.map(r => ({
                ...r,
                fdRenewalDaysRemaining: calculateDaysRemaining(r.fdMaturityDate)
            }));
            
            saveRecords(holder, records);
            displayRecords(records);
            updateBankSuggestions();
            loadFDsForInterest();
        }

        function displayRecords(records) {
            const tbody = document.getElementById('recordsTable');
            tbody.innerHTML = '';
            
            let filtered = records;
            if (currentFilter !== 'all') {
                filtered = records.filter(r => {
                    if (currentFilter === 'active') return r.fdRenewalDaysRemaining > 15;
                    if (currentFilter === 'expiring') return r.fdRenewalDaysRemaining >= 0 && r.fdRenewalDaysRemaining <= 15;
                    if (currentFilter === 'matured') return r.fdRenewalDaysRemaining < 0;
                    return true;
                });
            }
            
            filtered.forEach((record, index) => {
                const days = record.fdRenewalDaysRemaining;
                const statusClass = days > 15 ? 'status-active' : days >= 0 ? 'status-expiring' : 'status-matured';
                const statusText = days > 0 ? 'Active' : 'Matured';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="record-checkbox" data-index="${index}"></td>
                    <td>${record.bankName}</td>
                    <td>${formatCurrency(record.amount)}</td>
                    <td>${record.duration} ${record.durationUnit}</td>
                    <td>${record.interestRate}%</td>
                    <td>${formatDate(record.fdStartDate)}</td>
                    <td>${formatDate(record.fdMaturityDate)}</td>
                    <td class="${statusClass}">${days}</td>
                    <td>${formatCurrency(record.interest)}</td>
                    <td style="color: ${record.fdCertificate === 'obtained' ? 'var(--success)' : 'var(--danger)'}">
                        ${record.fdCertificate}
                    </td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <button onclick="editRecord(${index})">‚úèÔ∏è</button>
                        <button class="danger" onclick="deleteRecord(${index})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function saveFDRecord(event) {
            event.preventDefault();
            
            const holder = document.getElementById('accountHolderSelect').value;
            if (!holder) return showToast('Select an account holder first', 'error');
            
            const bankName = document.getElementById('bankName').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const duration = parseInt(document.getElementById('duration').value);
            const durationUnit = document.getElementById('durationUnit').value;
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const fdStartDate = document.getElementById('fdStartDate').value;
            const fdCertificate = document.getElementById('fdCertificate').value;
            const fdNotes = document.getElementById('fdNotes').value.trim();
            
            const fdMaturityDate = calculateMaturityDate(fdStartDate, duration, durationUnit);
            const fdRenewalDaysRemaining = calculateDaysRemaining(fdMaturityDate);
            const years = getDurationInYears(duration, durationUnit);
            const interest = calculateSimpleInterest(amount, interestRate, years);
            
            const record = {
                bankName, amount, duration, durationUnit, interestRate,
                fdStartDate, fdMaturityDate, fdRenewalDaysRemaining,
                interest, fdCertificate, fdNotes,
                certificateId: null
            };
            
            if (currentCertificateFile) {
                const certificates = getCertificates();
                const certId = Date.now().toString();
                certificates.push({
                    id: certId,
                    holder: holder,
                    bankName: bankName,
                    amount: amount,
                    fileName: currentCertificateFile.name,
                    fileType: currentCertificateFile.type,
                    fileData: currentCertificateFile.data,
                    uploadDate: new Date().toISOString()
                });
                saveCertificates(certificates);
                record.certificateId = certId;
                currentCertificateFile = null;
            }
            
            let records = getRecords(holder);
            const editIndex = document.getElementById('editIndex').value;
            
            if (editIndex !== '') {
                records[editIndex] = record;
                showToast('Record updated', 'success');
            } else {
                records.push(record);
                showToast('Record added', 'success');
            }
            
            saveRecords(holder, records);
            loadAccountRecords();
            clearForm();
        }

        function editRecord(index) {
            const holder = document.getElementById('accountHolderSelect').value;
            const records = getRecords(holder);
            const record = records[index];
            
            document.getElementById('bankName').value = record.bankName;
            document.getElementById('amount').value = record.amount;
            document.getElementById('duration').value = record.duration;
            document.getElementById('durationUnit').value = record.durationUnit;
            document.getElementById('interestRate').value = record.interestRate;
            document.getElementById('fdStartDate').value = record.fdStartDate;
            document.getElementById('fdCertificate').value = record.fdCertificate;
            document.getElementById('fdNotes').value = record.fdNotes || '';
            document.getElementById('editIndex').value = index;
            
            calculatePreview();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(index) {
            if (!confirm('Delete this record?')) return;
            
            const holder = document.getElementById('accountHolderSelect').value;
            let records = getRecords(holder);
            records.splice(index, 1);
            saveRecords(holder, records);
            loadAccountRecords();
            showToast('Record deleted', 'success');
        }

        function clearForm() {
            document.getElementById('fdForm').reset();
            document.getElementById('editIndex').value = '';
            document.getElementById('interestRate').value = '5';
            document.getElementById('certificatePreview').classList.add('hidden');
            currentCertificateFile = null;
            calculatePreview();
        }

        function calculatePreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const duration = parseInt(document.getElementById('duration').value) || 0;
            const unit = document.getElementById('durationUnit').value;
            const rate = parseFloat(document.getElementById('interestRate').value) || 0;
            
            if (amount && duration && rate) {
                const years = getDurationInYears(duration, unit);
                const interest = calculateSimpleInterest(amount, rate, years);
                document.getElementById('interestPreview').textContent = formatCurrency(interest);
            } else {
                document.getElementById('interestPreview').textContent = formatCurrency(0);
            }
        }

        function filterRecords() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const holder = document.getElementById('accountHolderSelect').value;
            if (!holder) return;
            
            const records = getRecords(holder);
            const filtered = records.filter(r => 
                r.bankName.toLowerCase().includes(search) ||
                r.amount.toString().includes(search) ||
                r.fdCertificate.toLowerCase().includes(search)
            );
            
            displayRecords(filtered);
        }

        function filterByStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-chips .chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');
            loadAccountRecords();
        }

        function sortTable(field) {
            const holder = document.getElementById('accountHolderSelect').value;
            if (!holder) return;
            
            let records = getRecords(holder);
            
            if (currentSort.field === field) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.field = field;
                currentSort.ascending = true;
            }
            
            records.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return currentSort.ascending ? -1 : 1;
                if (valA > valB) return currentSort.ascending ? 1 : -1;
                return 0;
            });
            
            saveRecords(holder, records);
            displayRecords(records);
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = checked);
        }

        function clearSelection() {
            document.getElementById('selectAll').checked = false;
            document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = false);
        }

        function bulkDelete() {
            const selected = getSelectedIndices();
            if (!selected.length) return showToast('No records selected', 'error');
            if (!confirm(`Delete ${selected.length} record(s)?`)) return;
            
            const holder = document.getElementById('accountHolderSelect').value;
            let records = getRecords(holder);
            selected.sort((a, b) => b - a).forEach(index => records.splice(index, 1));
            saveRecords(holder, records);
            loadAccountRecords();
            showToast('Records deleted', 'success');
        }

        function bulkExport() {
            const selected = getSelectedIndices();
            if (!selected.length) return showToast('No records selected', 'error');
            
            const holder = document.getElementById('accountHolderSelect').value;
            const records = getRecords(holder).filter((_, i) => selected.includes(i));
            exportRecordsToPDF(records, holder, `${holder}_Selected`);
        }

        function getSelectedIndices() {
            return Array.from(document.querySelectorAll('.record-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.index));
        }

        function updateBankSuggestions() {
            const datalist = document.getElementById('bankSuggestions');
            datalist.innerHTML = '';
            const banks = new Set();
            getAccountHolders().forEach(holder => {
                getRecords(holder).forEach(r => banks.add(r.bankName));
            });
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                datalist.appendChild(option);
            });
        }

        function updateDashboard() {
            const holders = getAccountHolders();
            let totalInvestment = 0;
            let totalInterest = 0;
            let activeFDs = 0;
            let expiringSoon = 0;
            const upcomingMaturities = [];
            
            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    totalInvestment += parseFloat(record.amount);
                    totalInterest += parseFloat(record.interest);
                    
                    const days = record.fdRenewalDaysRemaining;
                    if (days > 0) activeFDs++;
                    if (days >= 0 && days <= 30) {
                        expiringSoon++;
                        upcomingMaturities.push({
                            holder,
                            ...record
                        });
                    }
                });
            });

            document.getElementById('dashTotalInvestment').textContent = formatCurrency(totalInvestment);
            document.getElementById('dashTotalInterest').textContent = formatCurrency(totalInterest);
            document.getElementById('dashActiveFDs').textContent = activeFDs;
            document.getElementById('dashExpiringSoon').textContent = expiringSoon;

            const maturityContainer = document.getElementById('dashboardMaturities');
            if (upcomingMaturities.length === 0) {
                maturityContainer.innerHTML = '<p>No FDs maturing in the next 30 days</p>';
            } else {
                maturityContainer.innerHTML = upcomingMaturities
                    .sort((a, b) => a.fdRenewalDaysRemaining - b.fdRenewalDaysRemaining)
                    .map(fd => `
                        <div class="timeline-item">
                            <strong>${fd.holder} - ${fd.bankName}</strong><br>
                            Amount: ${formatCurrency(fd.amount)}<br>
                            Maturity: ${formatDate(fd.fdMaturityDate)}<br>
                            <span class="status-expiring">Days Remaining: ${fd.fdRenewalDaysRemaining}</span>
                        </div>
                    `).join('');
            }

            updateDashboardChart();
        }

        function updateDashboardChart() {
            const holders = getAccountHolders();
            const bankData = {};
            
            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    if (!bankData[record.bankName]) {
                        bankData[record.bankName] = 0;
                    }
                    bankData[record.bankName] += parseFloat(record.amount);
                });
            });

            const labels = Object.keys(bankData);
            const data = Object.values(bankData);

            const canvas = document.getElementById('dashboardChart');
            const ctx = canvas.getContext('2d');

            if (dashboardChart) {
                dashboardChart.destroy();
            }

            dashboardChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                            '#1abc9c', '#34495e', '#16a085', '#27ae60', '#2980b9'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function checkMaturityAlerts() {
            const holders = getAccountHolders();
            const alertDays = getSettings().alertDays;
            let alerts = [];

            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    const days = record.fdRenewalDaysRemaining;
                    if (days >= 0 && days <= alertDays) {
                        alerts.push(`${holder} - ${record.bankName}: ${days} days remaining`);
                    }
                });
            });

            if (alerts.length === 0) {
                showToast('No upcoming maturities!', 'success');
            } else {
                alert('Maturity Alerts:\n\n' + alerts.join('\n'));
            }
        }

        function loadFDsForInterest() {
            const holder = document.getElementById('interestAccountHolder')?.value;
            const select = document.getElementById('fdRecordSelect');
            
            if (!holder || !select) return;
            
            select.innerHTML = '<option value="">-- Select FD --</option>';
            const records = getRecords(holder);
            
            records.forEach((record, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${record.bankName} - ${formatCurrency(record.amount)}`;
                select.appendChild(option);
            });
        }

        function populateInterestFields() {
            const holder = document.getElementById('interestAccountHolder').value;
            const index = document.getElementById('fdRecordSelect').value;
            
            if (!holder || index === '') return;
            
            const records = getRecords(holder);
            const record = records[index];
            
            document.getElementById('manualAmount').value = record.amount;
            document.getElementById('manualRate').value = record.interestRate;
            document.getElementById('manualDuration').value = record.duration;
            document.getElementById('manualUnit').value = record.durationUnit;
            document.getElementById('interestFromDate').value = record.fdStartDate;
            document.getElementById('interestToDate').value = record.fdMaturityDate;
        }

        function togglePeriodFields() {
            const period = document.getElementById('calcPeriod').value;
            document.getElementById('customDateFields').classList.toggle('hidden', period !== 'custom');
            document.getElementById('manualInputFields').classList.toggle('hidden', period !== 'manual');
        }

        function calculateInterest() {
            const period = document.getElementById('calcPeriod').value;
            const type = document.getElementById('interestType').value;
            const frequency = document.getElementById('interestFrequency').value;
            
            let amount, rate, years;
            
            if (period === 'manual') {
                amount = parseFloat(document.getElementById('manualAmount').value);
                rate = parseFloat(document.getElementById('manualRate').value);
                const duration = parseInt(document.getElementById('manualDuration').value);
                const unit = document.getElementById('manualUnit').value;
                years = getDurationInYears(duration, unit);
            } else if (period === 'custom') {
                const holder = document.getElementById('interestAccountHolder').value;
                const index = document.getElementById('fdRecordSelect').value;
                const records = getRecords(holder);
                const record = records[index];
                
                amount = record.amount;
                rate = record.interestRate;
                
                const fromDate = new Date(document.getElementById('interestFromDate').value);
                const toDate = new Date(document.getElementById('interestToDate').value);
                years = (toDate - fromDate) / (1000 * 60 * 60 * 24 * 365.25);
            } else {
                const holder = document.getElementById('interestAccountHolder').value;
                const index = document.getElementById('fdRecordSelect').value;
                const records = getRecords(holder);
                const record = records[index];
                
                amount = record.amount;
                rate = record.interestRate;
                years = getDurationInYears(record.duration, record.durationUnit);
            }
            
            let interest;
            if (type === 'simple') {
                interest = calculateSimpleInterest(amount, rate, years);
            } else {
                interest = calculateCompoundInterest(amount, rate, years, frequency);
            }
            
            document.getElementById('calculatedInterest').textContent = formatCurrency(interest);
        }

        function saveInterestCalculation() {
            const amount = document.getElementById('manualAmount').value;
            const rate = document.getElementById('manualRate').value;
            const type = document.getElementById('interestType').value;
            const interest = document.getElementById('calculatedInterest').textContent;
            
            if (!amount || !rate) {
                showToast('Please calculate interest first', 'error');
                return;
            }
            
            const calculations = getSavedInterest();
            calculations.push({
                amount: parseFloat(amount),
                rate: parseFloat(rate),
                type: type,
                interest: interest,
                date: new Date().toISOString()
            });
            
            saveSavedInterest(calculations);
            loadSavedInterest();
            showToast('Calculation saved', 'success');
        }

        function loadSavedInterest() {
            const tbody = document.getElementById('savedInterestTable');
            const calculations = getSavedInterest();
            
            tbody.innerHTML = calculations.map((calc, index) => `
                <tr>
                    <td>${formatCurrency(calc.amount)}</td>
                    <td>${calc.rate}%</td>
                    <td>${calc.type}</td>
                    <td>${calc.interest}</td>
                    <td>
                        <button class="danger" onclick="deleteSavedInterest(${index})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteSavedInterest(index) {
            let calculations = getSavedInterest();
            calculations.splice(index, 1);
            saveSavedInterest(calculations);
            loadSavedInterest();
            showToast('Calculation deleted', 'success');
        }

        function clearAllSavedInterest() {
            if (!confirm('Clear all saved calculations?')) return;
            saveSavedInterest([]);
            loadSavedInterest();
            showToast('All calculations cleared', 'success');
        }

        function loadAnalytics() {
            const holders = getAccountHolders();
            const bankStats = {};
            
            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    if (!bankStats[record.bankName]) {
                        bankStats[record.bankName] = {
                            count: 0,
                            totalInvestment: 0,
                            totalInterest: 0,
                            rates: []
                        };
                    }
                    
                    bankStats[record.bankName].count++;
                    bankStats[record.bankName].totalInvestment += parseFloat(record.amount);
                    bankStats[record.bankName].totalInterest += parseFloat(record.interest);
                    bankStats[record.bankName].rates.push(parseFloat(record.interestRate));
                });
            });

            const tbody = document.getElementById('bankAnalysisTable');
            tbody.innerHTML = Object.keys(bankStats).map(bank => {
                const stats = bankStats[bank];
                const avgRate = (stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length).toFixed(2);
                
                return `
                    <tr>
                        <td>${bank}</td>
                        <td>${stats.count}</td>
                        <td>${formatCurrency(stats.totalInvestment)}</td>
                        <td>${formatCurrency(stats.totalInterest)}</td>
                        <td>${avgRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        function generateChart(type) {
            const holders = getAccountHolders();
            const bankData = {};
            
            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    if (!bankData[record.bankName]) {
                        bankData[record.bankName] = 0;
                    }
                    bankData[record.bankName] += parseFloat(record.amount);
                });
            });

            const labels = Object.keys(bankData);
            const data = Object.values(bankData);

            const canvas = document.getElementById('analyticsChart');
            const ctx = canvas.getContext('2d');

            if (analyticsChart) {
                analyticsChart.destroy();
            }

            analyticsChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Investment Amount',
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                            '#1abc9c', '#34495e', '#16a085', '#27ae60', '#2980b9'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function loadTimeline() {
            const holders = getAccountHolders();
            const allRecords = [];
            
            holders.forEach(holder => {
                const records = getRecords(holder);
                records.forEach(record => {
                    allRecords.push({
                        holder,
                        ...record
                    });
                });
            });

            allRecords.sort((a, b) => new Date(a.fdStartDate) - new Date(b.fdStartDate));

            const container = document.getElementById('timelineView');
            container.innerHTML = allRecords.map(record => `
                <div class="timeline-item">
                    <h3>${record.holder} - ${record.bankName}</h3>
                    <p>Amount: ${formatCurrency(record.amount)}</p>
                    <p>Start: ${formatDate(record.fdStartDate)} ‚Üí Maturity: ${formatDate(record.fdMaturityDate)}</p>
                    <p>Interest: ${formatCurrency(record.interest)} @ ${record.interestRate}%</p>
                </div>
            `).join('');
        }

        function addComparison(event) {
            event.preventDefault();
            
            const comparisons = getComparisons();
            comparisons.push({
                bankName: document.getElementById('compBankName').value,
                rate: parseFloat(document.getElementById('compRate').value),
                duration: parseInt(document.getElementById('compDuration').value),
                minAmount: parseFloat(document.getElementById('compMinAmount').value) || 0
            });
            
            saveComparisons(comparisons);
            displayComparisons();
            document.getElementById('comparisonForm').reset();
            showToast('Comparison added', 'success');
        }

        function displayComparisons() {
            const comparisons = getComparisons();
            const container = document.getElementById('comparisonResults');
            
            if (comparisons.length === 0) {
                container.innerHTML = '<p>No comparisons added yet</p>';
                return;
            }

            const maxRate = Math.max(...comparisons.map(c => c.rate));

            container.innerHTML = comparisons.map((comp, index) => `
                <div class="comparison-card ${comp.rate === maxRate ? 'best' : ''}">
                    <h3>${comp.bankName}</h3>
                    <p style="font-size: 2em; color: var(--success);">${comp.rate}%</p>
                    <p>${comp.duration} Months</p>
                    <p>Min: ${formatCurrency(comp.minAmount)}</p>
                    ${comp.rate === maxRate ? '<p style="color: var(--success); font-weight: bold;">‚ú® Best Rate</p>' : ''}
                    <button class="danger" onclick="deleteComparison(${index})">Remove</button>
                </div>
            `).join('');
        }

        function deleteComparison(index) {
            let comparisons = getComparisons();
            comparisons.splice(index, 1);
            saveComparisons(comparisons);
            displayComparisons();
            showToast('Comparison removed', 'success');
        }

        function clearComparisons() {
            if (!confirm('Clear all comparisons?')) return;
            saveComparisons([]);
            displayComparisons();
            showToast('All comparisons cleared', 'success');
        }

        function loadSettingsUI() {
            const settings = getSettings();
            document.getElementById('enableNotifications').checked = settings.enableNotifications;
            document.getElementById('alertDays').value = settings.alertDays;
            document.getElementById('autoSave').checked = settings.autoSave;
            document.getElementById('currencySymbol').value = settings.currencySymbol;
        }

        function backupData() {
            const backup = {
                version: '3.0',
                timestamp: new Date().toISOString(),
                accountHolders: getAccountHolders(),
                records: {},
                certificates: getCertificates(),
                savedInterest: getSavedInterest(),
                comparisons: getComparisons(),
                settings: getSettings()
            };

            getAccountHolders().forEach(holder => {
                backup.records[holder] = getRecords(holder);
            });

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FDManager_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup downloaded', 'success');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        saveAccountHolders(backup.accountHolders);
                        Object.keys(backup.records).forEach(holder => {
                            saveRecords(holder, backup.records[holder]);
                        });
                        saveCertificates(backup.certificates);
                        saveSavedInterest(backup.savedInterest);
                        saveComparisons(backup.comparisons);
                        localStorage.setItem('settings', JSON.stringify(backup.settings));
                        
                        showToast('Data restored successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        showToast('Invalid backup file', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data except your PIN! Continue?')) return;
            if (!confirm('Are you absolutely sure?')) return;
            
            const pin = localStorage.getItem('userPIN');
            localStorage.clear();
            localStorage.setItem('userPIN', pin);
            
            showToast('All data cleared', 'success');
            setTimeout(() => location.reload(), 1000);
        }

        function exportAllToPDF() {
            const holder = document.getElementById('accountHolderSelect').value;
            if (!holder) return showToast('Select an account holder first', 'error');
            
            const records = getRecords(holder);
            exportRecordsToPDF(records, holder, holder);
        }

        function exportRecordsToPDF(records, holder, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('FD Manager Pro - Records Export', 14, 15);
            doc.setFontSize(12);
            doc.text(`Account Holder: ${holder}`, 14, 25);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 32);
            
            const tableData = records.map(r => [
                r.bankName,
                formatCurrency(r.amount),
                `${r.duration} ${r.durationUnit}`,
                `${r.interestRate}%`,
                formatDate(r.fdStartDate),
                formatDate(r.fdMaturityDate),
                formatCurrency(r.interest)
            ]);
            
            doc.autoTable({
                startY: 40,
                head: [['Bank', 'Amount', 'Duration', 'Rate', 'Start', 'Maturity', 'Interest']],
                body: tableData
            });
            
            doc.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF exported', 'success');
        }

        function exportAllToExcel() {
            const holder = document.getElementById('accountHolderSelect').value;
            if (!holder) return showToast('Select an account holder first', 'error');
            
            const records = getRecords(holder);
            exportRecordsToExcel(records, holder);
        }

        function exportRecordsToExcel(records, holder) {
            const ws_data = [
                ['Bank Name', 'Amount', 'Duration', 'Unit', 'Rate %', 'Start Date', 'Maturity Date', 'Days Remaining', 'Interest', 'Certificate', 'Notes']
            ];
            
            records.forEach(r => {
                ws_data.push([
                    r.bankName,
                    r.amount,
                    r.duration,
                    r.durationUnit,
                    r.interestRate,
                    r.fdStartDate,
                    r.fdMaturityDate,
                    r.fdRenewalDaysRemaining,
                    r.interest,
                    r.fdCertificate,
                    r.fdNotes || ''
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, holder);
            XLSX.writeFile(wb, `${holder}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Excel exported', 'success');
        }

        function exportSavedInterestPDF() {
            const calculations = getSavedInterest();
            if (!calculations.length) return showToast('No calculations to export', 'error');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Saved Interest Calculations', 14, 15);
            
            const tableData = calculations.map(c => [
                formatCurrency(c.amount),
                `${c.rate}%`,
                c.type,
                c.interest
            ]);
            
            doc.autoTable({
                startY: 25,
                head: [['Amount', 'Rate', 'Type', 'Interest']],
                body: tableData
            });
            
            doc.save(`Interest_Calculations_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF exported', 'success');
        }

        function exportSavedInterestExcel() {
            const calculations = getSavedInterest();
            if (!calculations.length) return showToast('No calculations to export', 'error');
            
            const ws_data = [['Amount', 'Rate %', 'Type', 'Interest', 'Date']];
            
            calculations.forEach(c => {
                ws_data.push([
                    c.amount,
                    c.rate,
                    c.type,
                    c.interest,
                    new Date(c.date).toLocaleDateString()
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, 'Interest Calculations');
            XLSX.writeFile(wb, `Interest_Calculations_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Excel exported', 'success');
        }

        // Initialize app on load
        window.addEventListener('load', () => {
            const theme = localStorage.getItem('theme');
            if (theme) document.body.setAttribute('data-theme', theme);
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fdStartDate').value = today;
            
            // Load saved interest calculations
            loadSavedInterest();
            
            // Display comparisons
            displayComparisons();
            
            // Focus first PIN input
            document.getElementById('pin1').focus();
        });

        // PWA install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            const installPrompt = document.createElement('div');
            installPrompt.className = 'install-prompt';
            installPrompt.innerHTML = 'üì± Install FD Manager Pro';
            installPrompt.onclick = () => {
                e.prompt();
                installPrompt.remove();
            };
            document.body.appendChild(installPrompt);
            
            setTimeout(() => installPrompt.remove(), 10000);
        });

        // Service Worker for PWA (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")').catch(() => {});
        }
    </script>
</body>
</html>
